print("START 01_archive_search.js");

// +++++++++++++++++++++++++++++++++++++++ IAM DATABASE +++++++++++++++++++++++++++++++++++++++

print("INFO 01_archive_search.js : START iam database update");

db = db.getSiblingDB('{{ mongodb.iam.db }}')

// ========================================= PROFILES =========================================

// ----------------------------------------- LEVEL "0" -----------------------------------------

db.profiles.update(
    { "_id" : "system_archive_search_profile" },
    {
        "$set" : {
            "identifier" : NumberInt(22),
              "name": "Archive Search Profile",
              "description": "Archive Search Profile",
              "tenantIdentifier": NumberInt({{ vitamui_platform_informations.proof_tenant }}),
              "applicationName": "ARCHIVE_SEARCH_MANAGEMENT_APP",
              "level": "",
              "enabled": true,
              "readonly": false,
              "customerId": "system_customer",
              "roles": [
              {"name": "ROLE_CREATE_ARCHIVE_SEARCH"},
              {"name": "ROLE_GET_ARCHIVE_SEARCH"},
              {"name": "ROLE_GET_ALL_ARCHIVE_SEARCH"}
               ]
        },
        "$setOnInsert": {
            "_id" : "system_archive_search_profile"
        }
    },
    { "upsert":true }
);

// ========================================= GROUPS =========================================

// ----------------------------------------- LEVEL "0" -----------------------------------------

db.groups.updateOne(
	{
		"_id": "admin_group",
		"profileIds": { $nin: ["system_archive_search_profile"] }
	},
	{
		$addToSet: {"profileIds": "system_archive_search_profile" }
	},
	{
		"upsert": false
	}
);

db.groups.updateOne(
	{
		"_id": "super_admin_group",
		"profileIds": { $nin: ["system_archive_search_profile"] }
	},
	{
		$addToSet: {"profileIds": "system_archive_search_profile" }
	},
	{
		"upsert": false
	}
);

// ====================================== APPLICATIONS ======================================


db.applications.update(
    { "identifier" : "ARCHIVE_SEARCH_MANAGEMENT_APP" },
    {
        "$set" : {
{% if vitamui.archive_search.base_url is defined %}
        	"url": "{{ vitamui.ingest.base_url }}/archive-search",
{% else %}
            "url" : "{{ url_prefix }}/archive-search/archive-search",
{% endif %}
            "icon": "vitamui-icon vitamui-icon-archive-archive",
             "name": "Recherche et consultation des archives",
             "category": "ingests",
             "position": NumberInt(1),
             "hasCustomerList": false,
             "hasTenantList": false,
             "hasHighlight": false,
             "tooltip": "Recherche et consultation des archives",
             "target": "_self"
        },
        "$setOnInsert": {
            "identifier" : "ARCHIVE_SEARCH_MANAGEMENT_APP"
        }
    },
    { "upsert":true }
);

print("INFO 01_archive_search.js : END archive search database update");




print("END 01_archive_search.js");
